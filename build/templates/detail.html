<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ check.name }} - {{ site_title }}</title>
  <link rel="icon" type="image/svg+xml" href="../static/favicon.svg">
  <script>
    (function(){var t=localStorage.getItem('theme');if(t==='dark'||(t!=='light'&&matchMedia('(prefers-color-scheme:dark)').matches))document.documentElement.setAttribute('data-theme','dark');else document.documentElement.setAttribute('data-theme','light');})();
  </script>
  <link rel="stylesheet" href="../static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
  <div class="container" x-data="detailApp()">
    <header>
      <a href="../index.html" class="back-link">&larr; Back to overview</a>
      <h1>{{ check.name }}</h1>
      <p class="check-description">{{ check.description }}</p>
      {% if check.note %}<p class="check-note">{{ check.note }}</p>{% endif %}
      <div class="overall-status" :class="'status-banner-' + checkSummary.current_status">
        <span x-text="checkSummary.current_status"></span>
      </div>
    </header>

    <main>
      <!-- 90-day grid -->
      <div class="check-row">
        <div class="check-header">
          <span class="check-name">{{ check.name }}</span>
        </div>
        <div class="grid-90">
          <template x-for="day in checkSummary.days" :key="day.date">
            <div class="grid-cell"
                 :class="'cell-' + day.status + (selectedDate === day.date ? ' cell-selected' : '')"
                 :title="day.date"
                 @click="selectDate(day.date)"
                 @mouseenter="showCheckTooltip($event, day, '{{ check.name }}')"
                 @mouseleave="hideTooltip()">
            </div>
          </template>
          <div class="grid-cell cell-latest"
               :class="'cell-' + checkSummary.current_status"
               @click="checkSummary.latest_timestamp && selectDate(checkSummary.latest_timestamp.substring(0, 10))"
               @mouseenter="showLatestCellTooltip($event, checkSummary.current_status, '{{ check.name }}', checkSummary.latest_timestamp, checkSummary.latest_response_ms)"
               @mouseleave="hideTooltip()">
          </div>
        </div>
        <div class="grid-90-labels">
          <template x-for="lbl in ninetyDayLabels(checkSummary.days)" :key="lbl.label">
            <span class="grid-90-label-item" :style="'align-items:' + (lbl.isFirst ? 'flex-start' : lbl.isLast ? 'flex-end' : 'center')" x-text="lbl.label"></span>
          </template>
        </div>
      </div>

      <div x-data="{ open: false }">
        <div class="legend">
          <span class="legend-item"><span class="legend-color cell-up"></span> Up</span>
          <span class="legend-item"><span class="legend-color cell-degraded"></span> Degraded</span>
          <span class="legend-item"><span class="legend-color cell-down"></span> Down</span>
          <span class="legend-item"><span class="legend-color cell-nodata"></span> No Data</span>
          <button class="info-toggle legend-info-toggle" @click="open = !open" :aria-expanded="open" aria-label="Show status criteria">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"/>
            </svg>
          </button>
        </div>
        <div x-show="open" x-collapse>
          <div class="legend-criteria">
            <p><strong>Per component:</strong> Up = all checks passed; Degraded = &lt;50% of checks were down; Down = &ge;50% of checks were down</p>
          </div>
        </div>
      </div>

      <!-- Daily detail -->
      <section class="daily-detail">
        <div class="daily-detail-header">
          <div class="day-nav-group">
            <button class="day-nav-btn" :disabled="!prevDate()" @click="selectDate(prevDate())" aria-label="Previous day">&larr;</button>
            <h2 x-text="selectedDate ? 'Results for ' + selectedDate + ' (UTC)' : 'Click a day to view details'"></h2>
            <button class="day-nav-btn" :disabled="!nextDate()" @click="selectDate(nextDate())" aria-label="Next day">&rarr;</button>
          </div>
          <div x-show="hasLoadedData && dayRecords.length > 0" class="tz-switcher">
            <button :class="{ 'tz-active': !showLocalTime }" @click="showLocalTime = false">UTC</button>
            <button :class="{ 'tz-active': showLocalTime }" @click="showLocalTime = true" x-text="tzLabel"></button>
          </div>
        </div>
        <div x-show="loading && !hasLoadedData" class="loading">Loading...</div>

        <div x-show="hasLoadedData && dayRecords.length > 0" class="daily-content" :class="{ 'daily-content-loading': loading }">
          <!-- Hourly status grid -->
          <div>
            <h3 class="section-subheading" x-text="'Hourly Status (' + (showLocalTime ? tzLabel : 'UTC') + ')'"></h3>
            <div class="grid-24">
              <template x-for="h in hourlyStatus" :key="h.hour">
                <div class="grid-cell"
                     :class="'cell-' + h.status"
                     :title="h.hour + ':00 â€” ' + h.status + ' (' + h.count + ' checks)'"
                     @mouseenter="showHourTooltip($event, h)"
                     @mouseleave="hideTooltip()">
                </div>
              </template>
            </div>
            <div class="hour-labels">
              <template x-for="item in hourLabelsDisplay" :key="item.key">
                <span class="hour-label-item">
                  <span x-text="item.label"></span>
                  <span x-show="item.shift !== 0" x-text="item.shift > 0 ? '+1d' : '-1d'" class="hour-label-shift"></span>
                </span>
              </template>
            </div>
          </div>

          <!-- Response time chart -->
          <div class="chart-container">
            <h3 class="section-subheading">{% if check.type == 'knowledge' %}Indexing Time{% else %}Response Time{% endif %}</h3>
            <div class="chart-canvas-area">
              <canvas x-ref="responseChartUtc" :class="{ 'chart-inactive': showLocalTime }"></canvas>
              <canvas x-ref="responseChartLocal" :class="{ 'chart-inactive': !showLocalTime }"></canvas>
            </div>
          </div>

          <div>
            <table class="results-table">
              <thead>
                <tr>
                  <th x-text="showLocalTime ? 'Time (' + tzLabel + ')' : 'Time (UTC)'"></th>
                  <th>Status</th>
                  <th>{% if check.type == 'knowledge' %}Indexing Time{% else %}Response Time{% endif %}</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="r in dayRecords" :key="r.t">
                  <tr>
                    <td x-text="formatDisplayTime(r.t)"></td>
                    <td><span class="check-status-badge" :class="'badge-' + r.s" x-text="r.s"></span></td>
                    <td x-text="r.r >= 0 ? formatTime(r.r) : '-'"></td>
                    <td x-text="r.m"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
        <div x-show="!loading && selectedDate && dayRecords.length === 0" class="no-data">
          No data for this date.
        </div>
      </section>
    </main>

    {% include '_tooltip.html' %}

    {% include '_footer.html' %}
  </div>

  <script>
    const CHECK_SUMMARY = {{ check_summary_json | safe }};
    const CHECK_ID = "{{ check.id }}";
    const CHECK_TYPE = "{{ check.type }}";
  </script>
  <script src="../static/app.js"></script>
</body>
</html>
