<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ check.name }} - {{ site_title }}</title>
  <link rel="stylesheet" href="../static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
  <div class="container" x-data="detailApp()">
    <header>
      <a href="../index.html" class="back-link">&larr; Back to overview</a>
      <h1>{{ check.name }}</h1>
      <p class="check-description">{{ check.description }}</p>
      {% if check.note %}<p class="check-note">{{ check.note }}</p>{% endif %}
      <div class="overall-status" :class="'status-banner-' + checkSummary.current_status">
        <span x-text="checkSummary.current_status"></span>
      </div>
    </header>

    <main>
      <!-- 90-day grid -->
      <div class="check-row">
        <div class="check-header">
          <span class="check-name">{{ check.name }}</span>
        </div>
        <div class="grid-90">
          <template x-for="day in checkSummary.days" :key="day.date">
            <div class="grid-cell"
                 :class="'cell-' + day.status + (selectedDate === day.date ? ' cell-selected' : '')"
                 :title="day.date"
                 @click="selectDate(day.date)"
                 @mouseenter="showCheckTooltip($event, day, '{{ check.name }}')"
                 @mouseleave="hideTooltip()">
            </div>
          </template>
          <div class="grid-cell cell-latest"
               :class="'cell-' + checkSummary.current_status"
               @click="checkSummary.latest_timestamp && selectDate(checkSummary.latest_timestamp.substring(0, 10))"
               @mouseenter="showLatestCellTooltip($event, checkSummary.current_status, '{{ check.name }}', checkSummary.latest_timestamp, checkSummary.latest_response_ms)"
               @mouseleave="hideTooltip()">
          </div>
        </div>
      </div>

      <div x-data="{ open: false }">
        <div class="legend">
          <span class="legend-item"><span class="legend-color cell-up"></span> Up</span>
          <span class="legend-item"><span class="legend-color cell-degraded"></span> Degraded</span>
          <span class="legend-item"><span class="legend-color cell-down"></span> Down</span>
          <span class="legend-item"><span class="legend-color cell-nodata"></span> No Data</span>
          <button class="info-toggle legend-info-toggle" @click="open = !open" :aria-expanded="open" aria-label="Show status criteria">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"/>
            </svg>
          </button>
        </div>
        <div x-show="open" x-collapse>
          <div class="legend-criteria">
            <p><strong>Per component:</strong> Up = all checks passed; Degraded = &lt;50% of checks were down; Down = &ge;50% of checks were down</p>
          </div>
        </div>
      </div>

      <!-- Daily detail -->
      <section class="daily-detail">
        <div class="daily-detail-header">
          <div class="day-nav-group">
            <button class="day-nav-btn" :disabled="!prevDate()" @click="selectDate(prevDate())" aria-label="Previous day">&larr;</button>
            <h2 x-text="selectedDate ? 'Results for ' + selectedDate + ' (UTC)' : 'Click a day to view details'"></h2>
            <button class="day-nav-btn" :disabled="!nextDate()" @click="selectDate(nextDate())" aria-label="Next day">&rarr;</button>
          </div>
          <div x-show="hasLoadedData && dayRecords.length > 0" class="tz-switcher">
            <button :class="{ 'tz-active': !showLocalTime }" @click="showLocalTime = false">UTC</button>
            <button :class="{ 'tz-active': showLocalTime }" @click="showLocalTime = true" x-text="tzLabel"></button>
          </div>
        </div>
        <div x-show="loading && !hasLoadedData" class="loading">Loading...</div>

        <div x-show="hasLoadedData && dayRecords.length > 0" class="daily-content" :class="{ 'daily-content-loading': loading }">
          <!-- Hourly status grid -->
          <div>
            <h3 class="section-subheading" x-text="'Hourly Status (' + (showLocalTime ? tzLabel : 'UTC') + ')'"></h3>
            <div class="grid-24">
              <template x-for="h in hourlyStatus" :key="h.hour">
                <div class="grid-cell"
                     :class="'cell-' + h.status"
                     :title="h.hour + ':00 — ' + h.status + ' (' + h.count + ' checks)'"
                     @mouseenter="showHourTooltip($event, h)"
                     @mouseleave="hideTooltip()">
                </div>
              </template>
            </div>
            <div class="hour-labels">
              <template x-for="item in hourLabelsDisplay" :key="item.key">
                <span class="hour-label-item">
                  <span x-text="item.label"></span>
                  <span x-show="item.shift !== 0" x-text="item.shift > 0 ? '+1d' : '-1d'" class="hour-label-shift"></span>
                </span>
              </template>
            </div>
          </div>

          <!-- Response time chart -->
          <div class="chart-container">
            <h3 class="section-subheading">{% if check.type == 'knowledge' %}Indexing Time{% else %}Response Time{% endif %}</h3>
            <div class="chart-canvas-area">
              <canvas x-ref="responseChartUtc" :class="{ 'chart-inactive': showLocalTime }"></canvas>
              <canvas x-ref="responseChartLocal" :class="{ 'chart-inactive': !showLocalTime }"></canvas>
            </div>
          </div>

          <div>
            <table class="results-table">
              <thead>
                <tr>
                  <th x-text="showLocalTime ? 'Time (' + tzLabel + ')' : 'Time (UTC)'"></th>
                  <th>Status</th>
                  <th>{% if check.type == 'knowledge' %}Indexing Time{% else %}Response Time{% endif %}</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="r in dayRecords" :key="r.timestamp">
                  <tr>
                    <td x-text="formatDisplayTime(r.timestamp)"></td>
                    <td><span class="check-status-badge" :class="'badge-' + r.status" x-text="r.status"></span></td>
                    <td x-text="r.response_time_ms >= 0 ? formatTime(r.response_time_ms) : '-'"></td>
                    <td x-text="r.message"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
        <div x-show="!loading && selectedDate && dayRecords.length === 0" class="no-data">
          No data for this date.
        </div>
      </section>
    </main>

    <!-- Tooltip -->
    <div class="tooltip" x-show="tooltip.visible" x-transition
         :style="'left:' + tooltip.x + 'px; top:' + tooltip.y + 'px'">
      <div class="tooltip-date" x-text="tooltip.date"></div>
      <div x-show="tooltip.name" class="tooltip-name" x-text="tooltip.name"></div>
      <div class="tooltip-status" :class="'text-' + tooltip.status" x-text="tooltip.status"></div>
      <div x-show="tooltip.uptime !== null" class="tooltip-detail">
        Uptime: <span x-text="tooltip.uptime"></span>%
      </div>
      <div x-show="tooltip.avgResp >= 0" class="tooltip-detail">
        Avg response: <span x-text="tooltip.avgResp"></span> ms
      </div>
    </div>

    <footer>
      <p>This is an unofficial status page. Not affiliated with Dify.</p>
      <p>Built by <a href="https://github.com/kurokobo">@kurokobo</a> with AI assistance · <a href="https://github.com/kurokobo/dify-status">Source on GitHub</a></p>
      <div class="footer-support">
        <a href="https://github.com/sponsors/kurokobo" class="sponsor-btn" target="_blank" rel="noopener">
          <svg height="15" viewBox="0 0 16 16" fill="#c96198" style="vertical-align:middle;margin-right:5px;"><path d="M4.25 2.5c-1.336 0-2.75 1.164-2.75 3 0 2.15 1.58 4.144 3.365 5.682A20.565 20.565 0 008 13.393a20.561 20.561 0 003.135-2.211C12.92 9.644 14.5 7.65 14.5 5.5c0-1.836-1.414-3-2.75-3-1.373 0-2.609.986-3.029 2.456a.75.75 0 01-1.442 0C6.859 3.486 5.623 2.5 4.25 2.5z"/></svg>
          Sponsor on GitHub
        </a>
        <a href="https://www.buymeacoffee.com/kurokobo" class="bmc-btn" target="_blank" rel="noopener">
          <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height:45px;width:176px;border-radius:9px;">
        </a>
      </div>
    </footer>
  </div>

  <script>
    const SUMMARY_DATA = {{ summary_json | safe }};
    const CHECK_ID = "{{ check.id }}";
    const CHECK_TYPE = "{{ check.type }}";
  </script>
  <script src="../static/app.js"></script>
</body>
</html>
